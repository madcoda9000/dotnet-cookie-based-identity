\hypertarget{_claims_transformation_8cs_source}{}\doxysection{Claims\+Transformation.\+cs}
\label{_claims_transformation_8cs_source}\index{/Users/sascha.heimann/Projects/dotnet-\/cookie-\/based-\/identity/DotNetIdentity/IdentitySettings/ClaimsTransformation.cs@{/Users/sascha.heimann/Projects/dotnet-\/cookie-\/based-\/identity/DotNetIdentity/IdentitySettings/ClaimsTransformation.cs}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00001}00001 \textcolor{keyword}{using }System.Security.Claims;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00002}00002 \textcolor{keyword}{using }\mbox{\hyperlink{namespace_dot_net_identity_1_1_models_1_1_identity}{DotNetIdentity.Models.Identity}};}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00003}00003 \textcolor{keyword}{using }Microsoft.AspNetCore.Authentication;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00004}00004 \textcolor{keyword}{using }Microsoft.AspNetCore.Identity;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00005}00005 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00006}\mbox{\hyperlink{namespace_dot_net_identity_1_1_identity_settings}{00006}} \textcolor{keyword}{namespace }\mbox{\hyperlink{namespace_dot_net_identity_1_1_identity_settings}{DotNetIdentity.IdentitySettings}}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00007}00007 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00011}\mbox{\hyperlink{class_dot_net_identity_1_1_identity_settings_1_1_claims_transformation}{00011}}     \textcolor{keyword}{public} \textcolor{keyword}{class }\mbox{\hyperlink{class_dot_net_identity_1_1_identity_settings_1_1_claims_transformation}{ClaimsTransformation}} : IClaimsTransformation}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00012}00012     \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00016}00016         \textcolor{keyword}{private} readonly UserManager<AppUser> \_userManager;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00020}00020         \textcolor{keyword}{private} readonly RoleManager<AppRole> \_roleManager;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00021}00021 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00027}\mbox{\hyperlink{class_dot_net_identity_1_1_identity_settings_1_1_claims_transformation_ae5aa826f4387c6cb91e47f271990e971}{00027}}         \textcolor{keyword}{public} \mbox{\hyperlink{class_dot_net_identity_1_1_identity_settings_1_1_claims_transformation_ae5aa826f4387c6cb91e47f271990e971}{ClaimsTransformation}}(UserManager<AppUser> userManager, RoleManager<AppRole> roleManager)}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00028}00028         \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00029}00029             \_userManager = userManager;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00030}00030             \_roleManager = roleManager;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00031}00031         \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00032}00032 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00038}\mbox{\hyperlink{class_dot_net_identity_1_1_identity_settings_1_1_claims_transformation_aea519f343595461ed860cbfce1c0178e}{00038}}         \textcolor{keyword}{public} async Task<ClaimsPrincipal> \mbox{\hyperlink{class_dot_net_identity_1_1_identity_settings_1_1_claims_transformation_aea519f343595461ed860cbfce1c0178e}{TransformAsync}}(ClaimsPrincipal principal)}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00039}00039         \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00040}00040             var identity = principal.Identity as ClaimsIdentity;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00041}00041             var user = await \_userManager.FindByNameAsync(identity?.Name);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00042}00042             \textcolor{keywordflow}{if} (user != \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00043}00043             \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00044}00044                 \textcolor{keywordflow}{if} (!principal.HasClaim(c => c.Type == ClaimTypes.Gender))}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00045}00045                 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00046}00046                     var genderClaim = \textcolor{keyword}{new} Claim(ClaimTypes.Gender, Enum.GetName(user.Gender)!);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00047}00047                     identity?.AddClaim(genderClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00048}00048                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00049}00049 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00050}00050                 \textcolor{keywordflow}{if} (!principal.HasClaim(c => c.Type == ClaimTypes.DateOfBirth))}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00051}00051                 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00052}00052                     var birthDayClaim = \textcolor{keyword}{new} Claim(ClaimTypes.DateOfBirth, user.BirthDay.ToShortDateString());}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00053}00053                     identity?.AddClaim(birthDayClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00054}00054                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00055}00055 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00056}00056                 \textcolor{keywordflow}{if} (!principal.HasClaim(c => c.Type == \textcolor{stringliteral}{"{}FreeTrial"{}}))}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00057}00057                 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00058}00058                     var freeTrialClaim = \textcolor{keyword}{new} Claim(\textcolor{stringliteral}{"{}FreeTrial"{}}, user.CreatedOn.ToShortDateString());}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00059}00059                     identity?.AddClaim(freeTrialClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00060}00060                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00061}00061 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00062}00062                 \textcolor{keywordflow}{if} (!principal.HasClaim(c => c.Type == \textcolor{stringliteral}{"{}Department"{}}) \&\& !String.IsNullOrEmpty(user.Department))}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00063}00063                 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00064}00064                     var departmentClaim = \textcolor{keyword}{new} Claim(\textcolor{stringliteral}{"{}Department"{}}, user.Department!);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00065}00065                     identity?.AddClaim(departmentClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00066}00066                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00067}00067 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00068}00068                 \textcolor{keywordflow}{if} (!principal.HasClaim(c => c.Type == ClaimTypes.GivenName))}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00069}00069                 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00070}00070                     var givennameClaim = \textcolor{keyword}{new} Claim(ClaimTypes.GivenName, user.FirstName!);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00071}00071                     identity?.AddClaim(givennameClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00072}00072                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00073}00073 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00074}00074                 \textcolor{keywordflow}{if} (!principal.HasClaim(c => c.Type == ClaimTypes.Surname))}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00075}00075                 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00076}00076                     var surnameClaim = \textcolor{keyword}{new} Claim(ClaimTypes.Surname, user.LastName!);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00077}00077                     identity?.AddClaim(surnameClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00078}00078                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00079}00079 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00080}00080                 \textcolor{keywordflow}{if}(!principal.HasClaim(c=>c.Type==\textcolor{stringliteral}{"{}SelectedCulture"{}})) \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00081}00081                     var culture = System.Globalization.CultureInfo.CurrentCulture.ToString().ToLower();}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00082}00082                     var cultureClaim = \textcolor{keyword}{new} Claim(\textcolor{stringliteral}{"{}SelectedCulture"{}}, culture);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00083}00083                     identity?.AddClaim(cultureClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00084}00084                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00085}00085 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00086}00086                 \textcolor{keywordflow}{if} (!principal.HasClaim(c => c.Type == \textcolor{stringliteral}{"{}RolesCombined"{}}))}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00087}00087                 \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00088}00088                     var rls = await \_userManager.GetRolesAsync(user);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00089}00089                     \textcolor{keywordflow}{if} (rls != \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00090}00090                     \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00091}00091                         var rlsComb = \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00092}00092                         \textcolor{keywordflow}{if}(rls.Count()>0 \&\& rls.Count()<=1) \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00093}00093                             rlsComb = rls[0].ToString();}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00094}00094                         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00095}00095                             \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i=0;i<rls.Count;i++)}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00096}00096                             \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00097}00097                                 \textcolor{keywordflow}{if}(i+1!=rls.Count)\{ rlsComb += rls[i] + \textcolor{stringliteral}{"{},"{}}; \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00098}00098                                 \textcolor{keywordflow}{else} \{ rlsComb += rls[i]; \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00099}00099                             \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00100}00100                         \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00101}00101                         \textcolor{keywordflow}{if}(rlsComb.Length>0)}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00102}00102                         \{}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00103}00103                             var rolesCombinedClaim = \textcolor{keyword}{new} Claim(\textcolor{stringliteral}{"{}RolesCombined"{}}, rlsComb!);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00104}00104                             identity?.AddClaim(rolesCombinedClaim);}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00105}00105                         \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00106}00106                     \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00107}00107                 \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00108}00108             \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00109}00109 }
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00110}00110             \textcolor{keywordflow}{return} principal;}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00111}00111         \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00112}00112     \}}
\DoxyCodeLine{\Hypertarget{_claims_transformation_8cs_source_l00113}00113 \}}

\end{DoxyCode}
